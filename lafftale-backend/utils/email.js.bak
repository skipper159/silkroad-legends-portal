const nodemailer = require('nodemailer');
const crypto = require('crypto');
const path = require('path');
const config = require('../config');

// E-Mail-Transporter konfigurieren
const transporter = nodemailer.createTransport({
  host: process.env.EMAIL_HOST || 'smtp.example.com',
  port: process.env.EMAIL_PORT || 587,
  secure: process.env.EMAIL_SECURE === 'true',
  auth: {
    user: process.env.EMAIL_USER || 'user@example.com',
    pass: process.env.EMAIL_PASS || 'password',
  },
  debug: true,
  logger: true
});

// Token für Passwort-Reset oder E-Mail-Verifizierung erstellen
const generateToken = () => {
  return crypto.randomBytes(32).toString('hex');
};

// E-Mail für Kontoverifizierung senden
const sendVerificationEmail = async (email, token) => {
  // Verificationn-URL erstellen
  const verifyUrl = `${config.frontend.url}${config.frontend.routes.verify}/${token}`;

  // Logo-URL entweder auf absoluten Pfad oder lokale Datei setzen
  const logoUrl = config.email.templates.useAbsoluteUrls
    ? `${config.email.templates.imageBaseUrl}/image/Web/${config.email.imagePaths.logo}`
    : path.join(__dirname, '..', '..', 'public', 'image', 'Web', config.email.imagePaths.logo);

  // Attachments vorbereiten, falls lokale Bilder verwendet werden
  const attachments = config.email.templates.useAbsoluteUrls ? [] : [
    {
      filename: config.email.imagePaths.logo,
      path: logoUrl,
      cid: 'logo'
    }
  ];

  // Logo-Referenz im HTML basierend auf Konfiguration
  const logoSrc = config.email.templates.useAbsoluteUrls
    ? `${config.email.templates.imageBaseUrl}/image/Web/${config.email.imagePaths.logo}`
    : 'cid:logo';

  const mailOptions = {
    from: config.email.from,
    to: email,
    subject: 'Lafftale Online - Email Verification',
    html: `
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml">
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Email Verification</title>
        <style type="text/css">
          /* Grundlegende Stile, die in den meisten E-Mail-Clients funktionieren */
          body { margin: 0; padding: 0; min-width: 100%; font-family: Arial, sans-serif; }
          table { border-spacing: 0; font-family: Arial, sans-serif; }
          td { padding: 0; }
          img { border: 0; }
          .content { width: 600px; max-width: 100%; }
          .header { padding: 40px 30px 20px 30px; background-color: #1e293b; text-align: center; }
          .header-logo { display: inline-block; }
          .header-title { color: #d4af37; font-size: 28px; font-weight: bold; margin-top: 20px; }
          .container { padding: 30px 30px 40px 30px; background-color: #111827; color: #e0e0e0; }
          .footer { padding: 20px 30px; background-color: #1e293b; text-align: center; color: #9ca3af; }
          .button { display: inline-block; padding: 12px 25px; background-color: #d4af37; color: #000000 !important; text-decoration: none; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin: 25px 0; }
          .text-center { text-align: center; }
          .signature { margin-top: 30px; color: #9ca3af; font-size: 14px; }
        </style>
      </head>
      <body style="margin: 0; padding: 0; background-color: #0f172a;">
        <center>
          <table width="100%" cellpadding="0" cellspacing="0" bgcolor="#0f172a">
            <tr>
              <td align="center" valign="top">
                <!-- Header -->
                <table class="content" cellpadding="0" cellspacing="0">
                  <tr>
                    <td class="header">
                      <img src="${logoSrc}" alt="Lafftale Online Logo" width="100" style="display: block; margin: 0 auto;" />
                      <div class="header-title">Lafftale Online</div>
                    </td>
                  </tr>
                  <!-- Main Content -->
                  <tr>
                    <td class="container">
                      <p>Hallo,</p>
                      <p>Danke für deine Registrierung bei Lafftale Online! Um deine Registrierung abzuschließen, verifiziere bitte deine E-Mail-Adresse, indem du auf den Button unten klickst:</p>
                      
                      <div class="text-center">
                        <a href="${verifyUrl}" class="button">E-Mail verifizieren</a>
                      </div>
                      
                      <p>Dieser Verifizierungslink ist 24 Stunden gültig. Wenn du keinen Account erstellt hast, kannst du diese E-Mail ignorieren.</p>
                      
                      <div class="signature">
                        <p>Mit freundlichen Grüßen,<br>Das Lafftale Online Team</p>
                      </div>
                    </td>
                  </tr>
                  <!-- Footer -->
                  <tr>
                    <td class="footer">
                      <p>&copy; ${new Date().getFullYear()} Lafftale Online. Alle Rechte vorbehalten.</p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </center>
      </body>
      </html>
    `,
    attachments
  };

  return transporter.sendMail(mailOptions);
};

// E-Mail für Passwort-Reset senden
const sendPasswordResetEmail = async (email, token) => {
  // Reset-URL erstellen
  const resetUrl = `${config.frontend.url}${config.frontend.routes.reset}/${token}`;

  // Logo-URL entweder auf absoluten Pfad oder lokale Datei setzen
  const logoUrl = config.email.templates.useAbsoluteUrls
    ? `${config.email.templates.imageBaseUrl}/image/Web/${config.email.imagePaths.logo}`
    : path.join(__dirname, '..', '..', 'public', 'image', 'Web', config.email.imagePaths.logo);

  // Attachments vorbereiten, falls lokale Bilder verwendet werden
  const attachments = config.email.templates.useAbsoluteUrls ? [] : [
    {
      filename: config.email.imagePaths.logo,
      path: logoUrl,
      cid: 'logo'
    }
  ];

  // Logo-Referenz im HTML basierend auf Konfiguration
  const logoSrc = config.email.templates.useAbsoluteUrls
    ? `${config.email.templates.imageBaseUrl}/image/Web/${config.email.imagePaths.logo}`
    : 'cid:logo';

  const mailOptions = {
    from: config.email.from,
    to: email,
    subject: 'Lafftale Online - Passwort zurücksetzen',
    html: `
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml">
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Passwort zurücksetzen</title>
        <style type="text/css">
          /* Grundlegende Stile, die in den meisten E-Mail-Clients funktionieren */
          body { margin: 0; padding: 0; min-width: 100%; font-family: Arial, sans-serif; }
          table { border-spacing: 0; font-family: Arial, sans-serif; }
          td { padding: 0; }
          img { border: 0; }
          .content { width: 600px; max-width: 100%; }
          .header { padding: 40px 30px 20px 30px; background-color: #1e293b; text-align: center; }
          .header-logo { display: inline-block; }
          .header-title { color: #d4af37; font-size: 28px; font-weight: bold; margin-top: 20px; }
          .container { padding: 30px 30px 40px 30px; background-color: #111827; color: #e0e0e0; }
          .footer { padding: 20px 30px; background-color: #1e293b; text-align: center; color: #9ca3af; }
          .button { display: inline-block; padding: 12px 25px; background-color: #d4af37; color: #000000 !important; text-decoration: none; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin: 25px 0; }
          .text-center { text-align: center; }
          .signature { margin-top: 30px; color: #9ca3af; font-size: 14px; }
        </style>
      </head>
      <body style="margin: 0; padding: 0; background-color: #0f172a;">
        <center>
          <table width="100%" cellpadding="0" cellspacing="0" bgcolor="#0f172a">
            <tr>
              <td align="center" valign="top">
                <!-- Header -->
                <table class="content" cellpadding="0" cellspacing="0">
                  <tr>
                    <td class="header">
                      <img src="${logoSrc}" alt="Lafftale Online Logo" width="100" style="display: block; margin: 0 auto;" />
                      <div class="header-title">Lafftale Online</div>
                    </td>
                  </tr>
                  <!-- Main Content -->
                  <tr>
                    <td class="container">
                      <p>Hallo,</p>
                      <p>Du hast das Zurücksetzen deines Passworts für dein Lafftale Online-Konto angefordert. Bitte klicke auf den Button unten, um dein Passwort zurückzusetzen:</p>
                      
                      <div class="text-center">
                        <a href="${resetUrl}" class="button">Passwort zurücksetzen</a>
                      </div>
                      
                      <p>Dieser Link ist eine Stunde gültig. Wenn du keine Passwort-Zurücksetzung angefordert hast, kannst du diese E-Mail ignorieren.</p>
                      
                      <div class="signature">
                        <p>Mit freundlichen Grüßen,<br>Das Lafftale Online Team</p>
                      </div>
                    </td>
                  </tr>
                  <!-- Footer -->
                  <tr>
                    <td class="footer">
                      <p>&copy; ${new Date().getFullYear()} Lafftale Online. Alle Rechte vorbehalten.</p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </center>
      </body>
      </html>
    `,
    attachments
  };

  return transporter.sendMail(mailOptions);
};

  return transporter.sendMail(mailOptions);
};

  return transporter.sendMail(mailOptions);
};

module.exports = {
  sendPasswordResetEmail,
  generateToken,
  sendVerificationEmail
};
